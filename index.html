<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Inventario de Medicamentos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="icon" href="https://res.cloudinary.com/dqqeavica/image/upload/v1759697569/Jhonny_tvexdy.png">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
:root{
  --primary:#007BFF;
  --primary-2:#0056b3;
  --ok:#16a34a;
  --warn:#f59e0b;
  --orange:#f97316;
  --error:#dc2626;
  --scrim:rgba(0,0,0,.35);
}

html,body{
  margin:0; padding:0; height:100%; width:100%;
  overflow-x:hidden;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color:#111;
  background: url('https://res.cloudinary.com/dqqeavica/image/upload/v1753538930/FONDO_JHONNY_sugwsj.png') center/cover fixed no-repeat;
}

.container{ max-width: 1100px; margin: 0 auto; padding: 16px; }

/* VISTAS con transición */
.view{
  display:none; opacity:0; transform: translateY(8px);
  transition: opacity .25s ease, transform .25s ease;
  box-sizing:border-box;
  padding: 0 16px;
}
.view.active{ display:block; opacity:1; transform: translateY(0); }

/* Tarjetas */
.card{
  background: rgba(255,255,255,.06);
  backdrop-filter: blur(3px);
  border: 2px solid #ddd; border-radius: 10px;
  box-shadow: 0 8px 18px rgba(0,0,0,.15);
  margin: 16px auto;
  padding: 16px 16px 10px 16px;
}
.card.narrow{ max-width: 760px; }

h1,h2{ margin: 8px 0 12px; text-align:center; }
p.helper{ color:#666; font-size:.95rem; text-align:center; margin:8px 0 16px; }
.muted{ color:#666; font-size:.9rem; }
.center{ text-align:center; }
.image-center{ display:flex; justify-content:center; align-items:center; }

/* Inputs y botones */
label{ display:block; font-weight:800; margin: 10px 0 6px; color:var(--primary); }

input, select, textarea, button{
  width:100%; padding:12px; box-sizing:border-box;
  border:1.5px solid #ccc; border-radius:8px; background:#fff;
  outline:none; transition: border-color .2s ease, transform .08s ease;
  font-size:16px;
}
input:focus, select:focus, textarea:focus{ border-color:var(--primary); }

button{
  cursor:pointer; border:2px solid var(--primary);
  background:#fff; color:#000; font-weight:900;
}
button:hover{ background:var(--primary-2); color:#fff; border-color:var(--primary-2); }
.btn-primary{ background:var(--primary); color:#fff; border-color:var(--primary); }
.btn-row{ display:flex; gap:12px; }
.btn-row > *{ flex:1; }
@media (max-width: 700px){ .btn-row{ flex-direction:column; } }

.chip{
  padding:8px 12px; border-radius:999px; border:2px solid var(--primary);
  background:#fff; font-weight:900; color:#000;
}
.danger{ background:#e11; border-color:#e11; color:#fff; }

/* OVERLAY lateral (menú deslizable) */
.overlay{
  position: fixed;
  inset: 0;
  pointer-events:none;
}
.overlay .scrim{
  position:absolute; inset:0;
  background:var(--scrim);
  opacity:0; transition:opacity .25s ease;
}
.overlay .panel{
  position:absolute; top:0; left:0;
  width:min(360px, 90vw);
  height:100%;
  background:#000053;
  color:#fff;
  padding:16px 16px 8px 16px;
  box-sizing:border-box;
  transform: translateX(-100%);
  transition: transform .25s ease;
  display:flex;
  flex-direction:column;
  gap:10px;
  overflow-y:auto;
}
.overlay.open{ pointer-events:auto; }
.overlay.open .scrim{ opacity:1; }
.overlay.open .panel{ transform: translateX(0); }

.menu-btn{
  background: var(--primary);
  color:#fff;
  border:0;
  font-weight:900;
  border-radius:999px;
  padding:12px;
  box-shadow: 0 6px 12px rgba(0,0,0,.18);
}
.menu-btn:hover{ background: var(--primary-2); }

/* Loader centrado (overlay) */
.loader{
  position:fixed; inset:0;
  display:flex; align-items:center; justify-content:center;
  background:rgba(0,0,0,.35);
  z-index:9999; backdrop-filter: blur(2px);
  opacity:1; transition: opacity .12s ease;
  will-change: opacity;
}
.loader.hidden{
  display:flex !important;
  opacity:0; pointer-events:none;
}

/* Spinner iOS (12 barras) */
.spinner-ios{ position:relative; width:64px; height:64px; }
.spinner-ios i{
  position:absolute; left:50%; top:50%;
  width:6px; height:18px; margin:-9px 0 0 -3px;
  background:#fff; border-radius:3px;
  opacity:.2;
  animation:iosFade 1.2s linear infinite;
  transform-origin: center center;
}
@keyframes iosFade{ 0%, 39%, 100% { opacity:.2; } 40% { opacity:1; } }
.spinner-ios i:nth-child(1)  { transform: rotate(  0deg) translateY(-24px); animation-delay:-1.1s; }
.spinner-ios i:nth-child(2)  { transform: rotate( 30deg) translateY(-24px); animation-delay:-1.0s; }
.spinner-ios i:nth-child(3)  { transform: rotate( 60deg) translateY(-24px); animation-delay:-0.9s; }
.spinner-ios i:nth-child(4)  { transform: rotate( 90deg) translateY(-24px); animation-delay:-0.8s; }
.spinner-ios i:nth-child(5)  { transform: rotate(120deg) translateY(-24px); animation-delay:-0.7s; }
.spinner-ios i:nth-child(6)  { transform: rotate(150deg) translateY(-24px); animation-delay:-0.6s; }
.spinner-ios i:nth-child(7)  { transform: rotate(180deg) translateY(-24px); animation-delay:-0.5s; }
.spinner-ios i:nth-child(8)  { transform: rotate(210deg) translateY(-24px); animation-delay:-0.4s; }
.spinner-ios i:nth-child(9)  { transform: rotate(240deg) translateY(-24px); animation-delay:-0.3s; }
.spinner-ios i:nth-child(10) { transform: rotate(270deg) translateY(-24px); animation-delay:-0.2s; }
.spinner-ios i:nth-child(11) { transform: rotate(300deg) translateY(-24px); animation-delay:-0.1s; }
.spinner-ios i:nth-child(12) { transform: rotate(330deg) translateY(-24px); animation-delay: 0s; }

.hidden{ display:none !important; }

/* Listado estilo “cards” */
.list{
  max-width: 980px;
  margin: 0 auto;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.item{
  background: rgba(255,255,255,.92);
  border:2px solid #ddd;
  border-radius:16px;
  padding:12px;
  box-shadow:0 6px 14px rgba(0,0,0,.12);
  display:flex;
  gap:12px;
  align-items:flex-start;
}
.item-main{ flex:1; min-width:0; }

.item-title{
  margin:0;
  font-weight:900;
  color:#1b2a6b;
  text-transform:uppercase;
}
.item-sub{
  margin:4px 0 0;
  color:#333;
  font-weight:800;
  font-size:.9rem;
}
.item-meta{
  margin:6px 0 0;
  color:#666;
  font-size:.85rem;
  font-weight:800;
  overflow-wrap:anywhere;
}

.badge{
  min-width:96px;
  text-align:center;
  padding:6px 10px;
  border-radius:999px;
  font-weight:900;
  border:2px solid #111;
}
.badge.rojo{ background:#fee2e2; color:#991b1b; border-color:var(--error); }
.badge.naranja{ background:#ffedd5; color:#9a3412; border-color:var(--orange); }
.badge.amarillo{ background:#fef3c7; color:#92400e; border-color:var(--warn); }
.badge.verde{ background:#c6f6d5; color:#065f46; border-color:var(--ok); }

.item-actions{
  display:flex;
  flex-direction:column;
  gap:8px;
  min-width:160px;
}
.item-actions button{
  border-radius:999px;
  padding:10px;
}

/* Header actions */
.top-actions{
  display:flex;
  gap:12px;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
  margin-bottom:12px;
}
.top-actions-left{
  display:flex;
  gap:12px;
  align-items:center;
}
.brand{
  width:210px;
  border-radius:8px;
  display:block;
  margin:12px auto 4px;
}
</style>
</head>

<body>
<!-- Loader -->
<div id="loader" class="loader hidden" aria-live="polite" aria-busy="true">
  <div class="spinner-ios" role="status" aria-label="Cargando">
    <i></i><i></i><i></i><i></i><i></i><i></i>
    <i></i><i></i><i></i><i></i><i></i><i></i>
  </div>
</div>

<div class="container">

  <section id="view-main" class="view active">

    <div class="top-actions">
      <div class="top-actions-left">
        <button class="chip" id="btn-open-menu">MENÚ</button>
      </div>
      <div style="display:flex; gap:12px; align-items:center;">
        <button class="chip" id="btn-refresh">Actualizar</button>
        <button class="chip danger" id="btn-clear">Limpiar</button>
      </div>
    </div>

    <div class="card narrow">
      <h1 style="color:var(--primary); text-shadow:0 2px 2px #031732;">Inventario de Medicamentos</h1>
      <p class="helper"><b>Control de Stock con Entradas/Salidas y semáforo automático.</b></p>

      <div class="btn-row">
        <button class="btn-primary" id="btn-cargar">Cargar Stock</button>
        <button id="btn-nuevo">Nuevo Medicamento</button>
      </div>

      <label style="margin-top:14px;">Usuario (para movimientos)</label>
      <input id="usuario" type="text" placeholder="Ej: BOTHEART" value="BOTHEART" />

      <label>Buscar</label>
      <input id="q" type="text" placeholder="Nombre / presentación / ID..." />

      <p class="muted center" style="margin:10px 0 0;">
        Semáforo: <b>ROJO 0–2</b> / <b>NARANJA 3–5</b> / <b>AMARILLO 6–15</b> / <b>VERDE >15</b>
      </p>

      <div class="image-center">
        <img class="brand" alt="Brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" />
      </div>
      <p class="center muted">Copyright © BOTHEART</p>
    </div>

    <div class="list" id="list"></div>

  </section>
</div>

<!-- OVERLAY -->
<div class="overlay" id="overlay">
  <div class="scrim" id="ovlClose"></div>
  <aside class="panel">
    <div class="btn-row">
      <button id="btn-ovl-back">ATRÁS</button>
    </div>

    <div class="image-center">
      <img alt="banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1759696513/Jhonny_y1tslf.gif"
           style="max-width:180px;border-radius:10px;" />
    </div>

    <h3 style="text-align:center; margin:4px 0 6px;">Acciones</h3>

    <button class="menu-btn" id="menu-cargar">Cargar Stock</button>
    <button class="menu-btn" id="menu-nuevo">Nuevo Medicamento</button>
    <button class="menu-btn" id="menu-rebuild">Recalcular Stock</button>

    <div style="height:16px"></div>
    <img class="brand" alt="Brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" />
    <p class="center muted">Copyright © BOTHEART</p>
  </aside>
</div>

<script>
/* ================== CONFIG ================== */
/* Pega aquí tu URL real del Web App (/exec) */
const API_BASE = 'https://script.google.com/macros/s/AKfycbyX5lyzwDKN6XdojWUcZdnWDfXFpf0OIATBkGsI-of0uijcAUwlQNlRXFfCWH360PkYjA/exec';

/* ================== Loader (smart delay) ================== */
const loader = document.getElementById('loader');
let loadingCount = 0;
let loaderTimer = null;
function startLoading(){
  loadingCount++;
  if(loadingCount === 1){
    loaderTimer = setTimeout(()=>{
      loader.classList.remove('hidden');
      loaderTimer = null;
    }, 120);
  }
}
function stopLoading(){
  if(loadingCount === 0) return;
  loadingCount--;
  if(loadingCount === 0){
    if(loaderTimer){ clearTimeout(loaderTimer); loaderTimer = null; }
    loader.classList.add('hidden');
  }
}

/* ================== Sonidos (los tuyos) ================== */
const SOUNDS = {
  question: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_fail_ls2aif.mp3',
  info: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Default_notification_pkp4wr.mp3',
  success: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_success_t5aawh.mp3',
  error: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
  warning: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
  back: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Keyboard_Enter_b9k2dc.mp3',
  menu: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Namedrop_Popup_ale2zy.mp3'
};
function playSoundOnce(url){
  try{
    const a = new Audio(url);
    a.preload = 'auto';
    a.play().catch(()=>{});
  }catch(_){}
}
/* Patch SweetAlert2 para sonido por icono */
if(window.Swal && typeof Swal.fire === 'function'){
  const __fire = Swal.fire.bind(Swal);
  Swal.fire = function(options = {}, ...rest){
    try{
      const icon = options.icon || options.type;
      if(icon && SOUNDS[icon]) playSoundOnce(SOUNDS[icon]);
    }catch(_){}
    return __fire(options, ...rest);
  }
}

/* ================== API Helpers ================== */
async function apiGet(action, params = {}){
  startLoading();
  try{
    if(!API_BASE || API_BASE.includes('PUT_YOUR')) throw new Error('Configura API_BASE en el código.');
    const url = new URL(API_BASE);
    url.search = new URLSearchParams({ action, ...params }).toString();
    const r = await fetch(url.toString(), { method:'GET' });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Error');
    return j.data;
  } finally { stopLoading(); }
}
async function apiPost(action, body = {}){
  startLoading();
  try{
    if(!API_BASE || API_BASE.includes('PUT_YOUR')) throw new Error('Configura API_BASE en el código.');
    const url = API_BASE + '?action=' + encodeURIComponent(action);
    const r = await fetch(url, {
      method:'POST',
      headers: { 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify(body)
    });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Error');
    return j.data;
  } finally { stopLoading(); }
}

/* ================== UI ================== */
let STOCK_CACHE = [];

function badgeClass(estado){
  const e = String(estado||'').toLowerCase();
  if(e.includes('verde')) return 'verde';
  if(e.includes('amarillo')) return 'amarillo';
  if(e.includes('naranja')) return 'naranja';
  return 'rojo';
}

function render(items){
  const wrap = document.getElementById('list');
  wrap.innerHTML = '';

  if(!items.length){
    const p = document.createElement('p');
    p.className = 'muted center';
    p.textContent = 'No hay medicamentos para mostrar.';
    wrap.appendChild(p);
    return;
  }

  for(const it of items){
    const row = document.createElement('div');
    row.className = 'item';

    const main = document.createElement('div');
    main.className = 'item-main';

    const t = document.createElement('p');
    t.className = 'item-title';
    t.textContent = (it.nombre || '') + (it.presentacion ? (' — ' + it.presentacion) : '');

    const sub = document.createElement('p');
    sub.className = 'item-sub';
    sub.textContent = `ID: ${it.id_med} | Stock: ${it.stock}`;

    const meta = document.createElement('p');
    meta.className = 'item-meta';
    const dv = (it.dias_para_vencer === '' || it.dias_para_vencer === null) ? '—' : it.dias_para_vencer;
    meta.textContent = `Vence: ${it.fecha_vencimiento || '—'} | Días: ${dv} | Últ mov: ${it.ult_mov || '—'}`;

    main.appendChild(t);
    main.appendChild(sub);
    main.appendChild(meta);

    const badge = document.createElement('div');
    badge.className = 'badge ' + badgeClass(it.estado_color);
    badge.textContent = it.estado_color || 'ROJO';

    const actions = document.createElement('div');
    actions.className = 'item-actions';

    const bIn = document.createElement('button');
    bIn.className = 'btn-primary';
    bIn.textContent = '+ Entrada';
    bIn.addEventListener('click', ()=> movimiento(it.id_med, 'ENTRADA'));

    const bOut = document.createElement('button');
    bOut.textContent = '- Salida';
    bOut.addEventListener('click', ()=> movimiento(it.id_med, 'SALIDA'));

    actions.appendChild(bIn);
    actions.appendChild(bOut);

    row.appendChild(main);
    row.appendChild(badge);
    row.appendChild(actions);

    wrap.appendChild(row);
  }
}

async function loadStock(){
  const q = (document.getElementById('q').value || '').trim();
  const data = await apiGet('listStock', q ? { query:q } : {});
  STOCK_CACHE = Array.isArray(data) ? data : [];
  render(STOCK_CACHE);
}

function isDDMMYYYY(s){
  return /^(\d{2})\/(\d{2})\/(\d{4})$/.test(String(s||'').trim());
}

async function nuevoMedicamento(){
  const { value: v } = await Swal.fire({
    icon:'info',
    title:'Nuevo Medicamento',
    html: `
      <label style="text-align:left; font-weight:900; color:#007BFF; display:block; margin:0 0 6px;">Nombre</label>
      <input id="m-nombre" type="text" class="swal2-input" style="width:100%; margin:0;" />

      <label style="text-align:left; font-weight:900; color:#007BFF; display:block; margin:10px 0 6px;">Presentación</label>
      <input id="m-pres" type="text" class="swal2-input" style="width:100%; margin:0;" placeholder="Ej: Tabletas 500mg" />

      <label style="text-align:left; font-weight:900; color:#007BFF; display:block; margin:10px 0 6px;">Unidad</label>
      <input id="m-uni" type="text" class="swal2-input" style="width:100%; margin:0;" placeholder="Ej: caja / frasco" />

      <label style="text-align:left; font-weight:900; color:#007BFF; display:block; margin:10px 0 6px;">Categoría</label>
      <input id="m-cat" type="text" class="swal2-input" style="width:100%; margin:0;" placeholder="Ej: Analgésico" />

      <label style="text-align:left; font-weight:900; color:#007BFF; display:block; margin:10px 0 6px;">Fecha de vencimiento (dd/mm/yyyy)</label>
      <input id="m-v" type="text" class="swal2-input" style="width:100%; margin:0;" placeholder="31/12/2026" />
    `,
    showCancelButton:true,
    confirmButtonText:'Crear',
    cancelButtonText:'Cancelar',
    preConfirm: ()=>{
      const nombre = (document.getElementById('m-nombre').value || '').trim();
      const presentacion = (document.getElementById('m-pres').value || '').trim();
      const unidad = (document.getElementById('m-uni').value || '').trim();
      const categoria = (document.getElementById('m-cat').value || '').trim();
      const fecha_vencimiento = (document.getElementById('m-v').value || '').trim();

      if(!nombre) return Swal.showValidationMessage('Nombre requerido');
      if(!presentacion) return Swal.showValidationMessage('Presentación requerida');
      if(!isDDMMYYYY(fecha_vencimiento)) return Swal.showValidationMessage('Fecha inválida. Usa dd/mm/yyyy');

      return { nombre, presentacion, unidad, categoria, fecha_vencimiento };
    }
  });

  if(!v) return;

  const r = await apiPost('addMedicamento', v);
  await Swal.fire({ icon:'success', title:'Creado', text:'ID: ' + r.id_med, timer:2000, showConfirmButton:false });
  await apiPost('rebuildStock', {});
  await loadStock();
}

async function movimiento(id_med, tipo){
  const usuario = (document.getElementById('usuario').value || '').trim() || 'WEB';

  const { value: form } = await Swal.fire({
    icon:'question',
    title: (tipo === 'ENTRADA' ? 'Entrada' : 'Salida') + ' - ' + id_med,
    html: `
      <label style="text-align:left; font-weight:900; color:#007BFF; display:block; margin:0 0 6px;">Cantidad</label>
      <input id="mv-cant" type="number" min="1" step="1" class="swal2-input" style="width:100%; margin:0;" />

      <label style="text-align:left; font-weight:900; color:#007BFF; display:block; margin:10px 0 6px;">Observación</label>
      <input id="mv-obs" type="text" class="swal2-input" style="width:100%; margin:0;" placeholder="Opcional" />
    `,
    showCancelButton:true,
    confirmButtonText:'Guardar',
    cancelButtonText:'Cancelar',
    preConfirm: ()=>{
      const cant = Number(document.getElementById('mv-cant').value);
      const obs = (document.getElementById('mv-obs').value || '').trim();
      if(!(cant > 0)) return Swal.showValidationMessage('Cantidad inválida');
      return { cant, obs };
    }
  });

  if(!form) return;

  const r = await apiPost('movimiento', {
    id_med,
    tipo,
    cantidad: form.cant,
    observacion: form.obs,
    usuario
  });

  await Swal.fire({
    icon:'success',
    title:'Registrado',
    text:`Nuevo stock: ${r.stock} (${r.estado})`,
    timer: 2200,
    showConfirmButton:false
  });

  await loadStock();
}

/* ================== Overlay menu ================== */
const overlay = document.getElementById('overlay');
document.getElementById('btn-open-menu').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.menu);
  overlay.classList.add('open');
});
document.getElementById('btn-ovl-back').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  overlay.classList.remove('open');
});
document.getElementById('ovlClose').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  overlay.classList.remove('open');
});

/* ================== Botones ================== */
document.getElementById('btn-cargar').addEventListener('click', ()=> loadStock().catch(e=>{
  Swal.fire({ icon:'error', title:'Error', text:e.message });
}));
document.getElementById('btn-nuevo').addEventListener('click', ()=> nuevoMedicamento().catch(e=>{
  Swal.fire({ icon:'error', title:'Error', text:e.message });
}));
document.getElementById('btn-refresh').addEventListener('click', ()=> loadStock().catch(()=>{}));
document.getElementById('btn-clear').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  document.getElementById('q').value = '';
  document.getElementById('list').innerHTML = '';
});

/* Menú lateral */
document.getElementById('menu-cargar').addEventListener('click', ()=>{
  overlay.classList.remove('open');
  loadStock().catch(()=>{});
});
document.getElementById('menu-nuevo').addEventListener('click', ()=>{
  overlay.classList.remove('open');
  nuevoMedicamento().catch(()=>{});
});
document.getElementById('menu-rebuild').addEventListener('click', async ()=>{
  overlay.classList.remove('open');
  try{
    await apiPost('rebuildStock', {});
    Swal.fire({ icon:'success', title:'Stock recalculado', timer:1500, showConfirmButton:false });
    await loadStock();
  }catch(e){
    Swal.fire({ icon:'error', title:'Error', text:e.message });
  }
});

/* Filtro con debounce */
document.getElementById('q').addEventListener('input', ()=>{
  clearTimeout(window.__tq);
  window.__tq = setTimeout(()=> loadStock().catch(()=>{}), 220);
});
</script>
</body>
</html>
