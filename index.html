<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Inventario de Medicamentos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="icon" href="https://res.cloudinary.com/dqqeavica/image/upload/v1759697569/Jhonny_tvexdy.png">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
:root{
  --primary:#007BFF;
  --primary-2:#0056b3;
  --ok:#16a34a;
  --warn:#f59e0b;
  --orange:#f97316;
  --error:#dc2626;
  --scrim:rgba(0,0,0,.35);
}

html,body{
  margin:0; padding:0; height:100%; width:100%;
  overflow-x:hidden;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color:#111;
  background: url('https://res.cloudinary.com/dqqeavica/image/upload/v1753538930/FONDO_JHONNY_sugwsj.png') center/cover fixed no-repeat;
}

.container{ max-width: 1100px; margin: 0 auto; padding: 16px; }

.view{ display:none; opacity:0; transform: translateY(8px);
  transition: opacity .25s ease, transform .25s ease;
  box-sizing:border-box; padding: 0 16px;
}
.view.active{ display:block; opacity:1; transform: translateY(0); }

.card{
  background: rgba(255,255,255,.06);
  backdrop-filter: blur(3px);
  border: 2px solid #ddd; border-radius: 10px;
  box-shadow: 0 8px 18px rgba(0,0,0,.15);
  margin: 16px auto; padding: 16px 16px 10px 16px;
}
.card.narrow{ max-width: 760px; }

h1,h2{ margin: 8px 0 12px; text-align:center; }
p.helper{ color:#666; font-size:.95rem; text-align:center; margin:8px 0 16px; }
.muted{ color:#666; font-size:.9rem; }
.center{ text-align:center; }
.image-center{ display:flex; justify-content:center; align-items:center; }

label{ display:block; font-weight:800; margin: 10px 0 6px; color:var(--primary); }

input, select, textarea, button{
  width:100%; padding:12px; box-sizing:border-box;
  border:1.5px solid #ccc; border-radius:8px; background:#fff;
  outline:none; transition: border-color .2s ease, transform .08s ease;
  font-size:16px;
}
input:focus, select:focus, textarea:focus{ border-color:var(--primary); }

button{
  cursor:pointer; border:2px solid var(--primary);
  background:#fff; color:#000; font-weight:900;
}
button:hover{ background:var(--primary-2); color:#fff; border-color:var(--primary-2); }
.btn-primary{ background:var(--primary); color:#fff; border-color:var(--primary); }
.btn-row{ display:flex; gap:12px; }
.btn-row > *{ flex:1; }
@media (max-width: 700px){ .btn-row{ flex-direction:column; } }

.chip{
  padding:8px 12px; border-radius:999px; border:2px solid var(--primary);
  background:#fff; font-weight:900; color:#000;
}
.danger{ background:#e11; border-color:#e11; color:#fff; }

.loader{
  position:fixed; inset:0;
  display:flex; align-items:center; justify-content:center;
  background:rgba(0,0,0,.35);
  z-index:9999; backdrop-filter: blur(2px);
  opacity:1; transition: opacity .12s ease;
  will-change: opacity;
}
.loader.hidden{ display:flex !important; opacity:0; pointer-events:none; }

.spinner-ios{ position:relative; width:64px; height:64px; }
.spinner-ios i{
  position:absolute; left:50%; top:50%;
  width:6px; height:18px; margin:-9px 0 0 -3px;
  background:#fff; border-radius:3px;
  opacity:.2;
  animation:iosFade 1.2s linear infinite;
  transform-origin: center center;
}
@keyframes iosFade{ 0%, 39%, 100% { opacity:.2; } 40% { opacity:1; } }
.spinner-ios i:nth-child(1)  { transform: rotate(  0deg) translateY(-24px); animation-delay:-1.1s; }
.spinner-ios i:nth-child(2)  { transform: rotate( 30deg) translateY(-24px); animation-delay:-1.0s; }
.spinner-ios i:nth-child(3)  { transform: rotate( 60deg) translateY(-24px); animation-delay:-0.9s; }
.spinner-ios i:nth-child(4)  { transform: rotate( 90deg) translateY(-24px); animation-delay:-0.8s; }
.spinner-ios i:nth-child(5)  { transform: rotate(120deg) translateY(-24px); animation-delay:-0.7s; }
.spinner-ios i:nth-child(6)  { transform: rotate(150deg) translateY(-24px); animation-delay:-0.6s; }
.spinner-ios i:nth-child(7)  { transform: rotate(180deg) translateY(-24px); animation-delay:-0.5s; }
.spinner-ios i:nth-child(8)  { transform: rotate(210deg) translateY(-24px); animation-delay:-0.4s; }
.spinner-ios i:nth-child(9)  { transform: rotate(240deg) translateY(-24px); animation-delay:-0.3s; }
.spinner-ios i:nth-child(10) { transform: rotate(270deg) translateY(-24px); animation-delay:-0.2s; }
.spinner-ios i:nth-child(11) { transform: rotate(300deg) translateY(-24px); animation-delay:-0.1s; }
.spinner-ios i:nth-child(12) { transform: rotate(330deg) translateY(-24px); animation-delay: 0s; }

.hidden{ display:none !important; }

.list{
  max-width: 980px;
  margin: 0 auto;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.item{
  background: rgba(255,255,255,.92);
  border:2px solid #ddd;
  border-radius:18px;
  padding:14px;
  box-shadow:0 10px 24px rgba(0,0,0,.18);
  display:flex;
  gap:12px;
  align-items:flex-start;
}
.item-main{ flex:1; min-width:0; }

.item-title{
  margin:0;
  font-weight:900;
  color:#1b2a6b;
  text-transform:uppercase;
  letter-spacing:.2px;
}
.item-sub{
  margin:6px 0 0;
  color:#333;
  font-weight:900;
  font-size:.92rem;
}
.item-meta{
  margin:8px 0 0;
  color:#444;
  font-size:.86rem;
  font-weight:800;
  overflow-wrap:anywhere;
  line-height:1.35;
}

.badge{
  min-width:160px;
  text-align:center;
  padding:8px 12px;
  border-radius:999px;
  font-weight:900;
  border:2px solid #111;
  box-shadow:0 6px 12px rgba(0,0,0,.10);
}
.badge.agotado{ background:#fee2e2; color:#991b1b; border-color:var(--error); }
.badge.ingresar{ background:#ffedd5; color:#9a3412; border-color:var(--orange); }
.badge.estable{ background:#fef3c7; color:#92400e; border-color:var(--warn); }
.badge.surtido{ background:#c6f6d5; color:#065f46; border-color:var(--ok); }

.item-actions{
  display:flex;
  flex-direction:column;
  gap:10px;
  min-width:220px;
}
.item-actions button{
  border-radius:999px;
  padding:12px;
  font-size:1rem;
}

.top-actions{
  display:flex;
  gap:12px;
  align-items:center;
  justify-content:flex-end;
  flex-wrap:wrap;
  margin-bottom:12px;
}
.brand{
  width:210px;
  border-radius:8px;
  display:block;
  margin:12px auto 4px;
}

/* modal date (copiado de indexref) */
.picker-modal-cal{ position:fixed; inset:0; display:none; align-items:flex-start; justify-content:center; padding-top:32px; background:rgba(0,0,0,.5); z-index:9999; }
.picker-box-cal{ width:90%; max-width:520px; background:#fff; border-radius:8px; padding:16px; box-shadow:0 8px 18px rgba(0,0,0,.18); }
.picker-grid-cal{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin:12px 0; }
.picker-grid-cal select{ width:100%; height:180px; }

  .swal2-select,
.swal2-select option,
select.swal2-select {
  text-align: center; /* centra el texto dentro del <select> y (cuando el navegador lo respete) en las opciones */
}

/* fallback: centrar texto del control select genérico en formularios */
select {
  text-align: center;
}
</style>
</head>

<body>
<div id="loader" class="loader hidden" aria-live="polite" aria-busy="true">
  <div class="spinner-ios" role="status" aria-label="Cargando">
    <i></i><i></i><i></i><i></i><i></i><i></i>
    <i></i><i></i><i></i><i></i><i></i><i></i>
  </div>
</div>

<div class="container">
  <section id="view-main" class="view active">
    <div class="top-actions">
      <button class="chip danger" id="btn-clear">Limpiar</button>
    </div>

    <div class="card narrow">
      <h1 style="color:var(--primary); text-shadow:0 2px 2px #031732;">Inventario de Medicamentos</h1>
      <p class="helper"><b>Control de Stock con Entradas/Salidas y semáforo automático.</b></p>

      <div class="btn-row">
        <button class="btn-primary" id="btn-cargar">Cargar Stock</button>
        <button id="btn-nuevo">Nuevo Medicamento</button>
      </div>

      <label style="margin-top:14px;">Usuario (para movimientos)</label>
      <input id="usuario" type="text" placeholder="Escríbe tu nombre" />

      <label>Buscar</label>
      <input id="q" type="text" placeholder="Nombre / presentación / ID / ubicación / categoría..." />

      <p class="muted center" style="margin:10px 0 0;">
        Semáforo: <b>AGOTADO 0–2</b> / <b>INGRESAR MÁS 3–5</b> / <b>ESTABLE 6–15</b> / <b>SURTIDO &gt;15</b>
      </p>

      <div class="image-center">
        <img class="brand" alt="Brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" />
      </div>
      <p class="center muted">Copyright © BOTHEART</p>
    </div>

    <div class="list" id="list"></div>
  </section>
</div>

<!-- Date picker modal (reusable para add/edit) -->
<div id="eventoFechaModal" class="picker-modal-cal" aria-hidden="true">
  <div class="picker-box-cal">
    <h3 style="margin:0 0 8px 0;">Selecciona la Fecha</h3>
    <div class="picker-grid-cal">
      <div>
        <small>Día</small>
        <select id="evtDia" size="10"></select>
      </div>
      <div>
        <small>Mes</small>
        <select id="evtMes" size="12"></select>
      </div>
      <div>
        <small>Año</small>
        <select id="evtAnio" size="10"></select>
      </div>
    </div>
    <div style="display:flex; gap:8px; justify-content:flex-end;">
      <button type="button" class="btn" id="evtFechaCancelar">Cancelar</button>
      <button type="button" class="btn-primary" id="evtFechaOk">Ok</button>
    </div>
  </div>
</div>

<script>
/* ================== CONFIG ================== */
const API_BASE = 'https://script.google.com/macros/s/AKfycbyX5lyzwDKN6XdojWUcZdnWDfXFpf0OIATBkGsI-of0uijcAUwlQNlRXFfCWH360PkYjA/exec';

/* ================== CATEGORIES ================== */
const CATEGORIES = [
  { name:'Analgésicos', desc:'Alivio del dolor.' },
  { name:'Antipiréticos', desc:'Reducción de la fiebre.' },
  { name:'Antiinflamatorios', desc:'Reducción de la inflamación.' },
  { name:'Antibióticos', desc:'Contra infecciones bacterianas.' },
  { name:'Antivirales', desc:'Contra infecciones por virus.' },
  { name:'Antifúngicos (Antimicóticos)', desc:'Contra hongos.' },
  { name:'Antiparasitarios', desc:'Contra parásitos.' },
  { name:'Antihistamínicos', desc:'Contra reacciones alérgicas.' },
  { name:'Antihipertensivos', desc:'Control de la presión arterial.' },
  { name:'Hipoglucemiantes / Antidiabéticos', desc:'Control de la glucosa.' },
  { name:'Gastrointestinales', desc:'Antiácidos, antiulcerosos, laxantes y antidiarreicos.' },
  { name:'Antitusígenos y Expectorantes', desc:'Para la tos y flemas.' },
  { name:'Antidepresivos y Ansiolíticos', desc:'Salud mental y sistema nervioso.' },
  { name:'Anticoagulantes', desc:'Prevención de coágulos.' },
  { name:'Diuréticos', desc:'Eliminación de líquidos.' },
  { name:'Hormonales', desc:'Anticonceptivos, corticoides o tiroideos.' },
  { name:'Material de Curación', desc:'Gasas, vendas, apósitos, algodones y cintas adhesivas.' },
  { name:'Material Quirúrgico', desc:'Bisturís, suturas, guantes estériles y campos quirúrgicos.' },
  { name:'Dispositivos de Inyección y Punción', desc:'Jeringas, agujas, catéteres y equipos de venoclisis.' },
  { name:'Equipo Biomédico', desc:'Monitores, tensiómetros, glucómetros y termómetros.' },
  { name:'Agentes de Diagnóstico', desc:'Pruebas rápidas, reactivos y medios de contraste.' },
  { name:'Insumos Higiénicos y de Protección', desc:'Mascarillas, batas desechables, caretas y antisépticos (alcohol, gel).' },
  { name:'Ayudas Funcionales y Prótesis', desc:'Sillas de ruedas, muletas, andaderas e implantes.' },
  { name:'Insumos Odontológicos', desc:'Resinas, amalgamas y materiales de impresión dental.' }
];
const CAT_DESC = new Map(CATEGORIES.map(c => [c.name, c.desc]));
function catLabel(name){
  const n = String(name || '').trim();
  if(!n) return '—';
  const d = CAT_DESC.get(n);
  return d ? `${n}: ${d}` : n;
}

/* ================== Loader ================== */
const loader = document.getElementById('loader');
let loadingCount = 0;
let loaderTimer = null;
function startLoading(){ loadingCount++; if(loadingCount===1){ loaderTimer = setTimeout(()=>{ loader.classList.remove('hidden'); loaderTimer=null; },120); } }
function stopLoading(){ if(loadingCount===0) return; loadingCount--; if(loadingCount===0){ if(loaderTimer){ clearTimeout(loaderTimer); loaderTimer=null; } loader.classList.add('hidden'); } }

/* ================== Sounds / Swal patch ================== */
const SOUNDS = {
  question:'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_fail_ls2aif.mp3',
  info:'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Default_notification_pkp4wr.mp3',
  success:'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_success_t5aawh.mp3',
  error:'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
  warning:'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
  back:'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Keyboard_Enter_b9k2dc.mp3'
};
function playSoundOnce(url){ try{ const a=new Audio(url); a.preload='auto'; a.play().catch(()=>{}); }catch(_){ } }
if(window.Swal && typeof Swal.fire==='function'){
  const __fire = Swal.fire.bind(Swal);
  Swal.fire = function(options={},...rest){ try{ const icon = options.icon || options.type; if(icon && SOUNDS[icon]) playSoundOnce(SOUNDS[icon]); }catch(_){}
    return __fire(options,...rest);
  };
}

/* ================== API helpers ================== */
async function apiGet(action, params={}){ startLoading(); try{ const url=new URL(API_BASE); url.search=new URLSearchParams({ action, ...params }).toString(); const r=await fetch(url.toString(),{method:'GET'}); const j=await r.json(); if(!j.ok) throw new Error(j.error||'Error'); return j.data; } finally{ stopLoading(); } }
async function apiPost(action, body={}){ startLoading(); try{ const url = API_BASE + '?action=' + encodeURIComponent(action); const r = await fetch(url, { method:'POST', headers:{ 'Content-Type':'text/plain;charset=utf-8' }, body: JSON.stringify(body) }); const j = await r.json(); if(!j.ok) throw new Error(j.error||'Error'); return j.data; } finally{ stopLoading(); } }

/* ================== Estado por stock ================== */
function estadoPorStock(stock){
  const s = Number(stock ?? 0);
  if(s <= 2) return { label:'AGOTADO', cls:'agotado' };
  if(s <= 5) return { label:'INGRESAR MÁS', cls:'ingresar' };
  if(s <= 15) return { label:'ESTABLE', cls:'estable' };
  return { label:'SURTIDO', cls:'surtido' };
}

/* ================== Render listado ================== */
function escapeHtml(str){ return String(str||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;"); }

function render(items){
  const wrap = document.getElementById('list');
  wrap.innerHTML='';
  if(!items.length){ const p=document.createElement('p'); p.className='muted center'; p.textContent='No hay medicamentos para mostrar.'; wrap.appendChild(p); return; }
  items.forEach(it=>{
    const row=document.createElement('div'); row.className='item';
    const main=document.createElement('div'); main.className='item-main';
    const t=document.createElement('p'); t.className='item-title'; t.textContent=(it.nombre||'') + (it.presentacion?(' — '+it.presentacion):'');
    const sub=document.createElement('p'); sub.className='item-sub'; sub.textContent=`ID: ${it.id_med} | Stock: ${it.stock}`;
    const meta=document.createElement('p'); meta.className='item-meta';
    const dv = (it.dias_para_vencer==='' || it.dias_para_vencer===null)?'—':it.dias_para_vencer;
    const ubic = it.ubicacion||'—';
    meta.innerHTML = `<b>Ubicación:</b> ${escapeHtml(ubic)}<br><b>Categoría:</b> ${escapeHtml(catLabel(it.categoria))}<br>Vence: ${escapeHtml(it.fecha_vencimiento||'—')} | Días: ${escapeHtml(String(dv))} | Últ mov: ${escapeHtml(it.ult_mov||'—')}`;
    main.appendChild(t); main.appendChild(sub); main.appendChild(meta);
    const est = estadoPorStock(it.stock);
    const badge=document.createElement('div'); badge.className='badge '+est.cls; badge.textContent=est.label;
    const actions=document.createElement('div'); actions.className='item-actions';
    const bIn=document.createElement('button'); bIn.className='btn-primary'; bIn.textContent='+ Entrada'; bIn.addEventListener('click', ()=> movimiento(it.id_med,'ENTRADA'));
    const bOut=document.createElement('button'); bOut.textContent='- Salida'; bOut.addEventListener('click', ()=> movimiento(it.id_med,'SALIDA'));
    // ✅ Edit button
    const bEdit=document.createElement('button'); bEdit.textContent='Editar'; bEdit.addEventListener('click', ()=> editarMedicamento(it.id_med));
    actions.appendChild(bIn); actions.appendChild(bOut); actions.appendChild(bEdit);
    row.appendChild(main); row.appendChild(badge); row.appendChild(actions);
    wrap.appendChild(row);
  });
}

/* ================== Load stock ================== */
let STOCK_CACHE = [];
async function loadStock(){ const q=(document.getElementById('q').value||'').trim(); const data = await apiGet('listStock', q?{query:q}:{}); STOCK_CACHE = Array.isArray(data)?data:[]; render(STOCK_CACHE); }

/* ================== Categories select html helper ================== */
function categoryOptionsHtml(selectedName){
  return CATEGORIES.map(c=>{
    const label = `${c.name}: ${c.desc}`;
    const sel = (selectedName && selectedName===c.name) ? 'selected' : '';
    return `<option value="${escapeHtml(c.name)}" ${sel}>${escapeHtml(label)}</option>`;
  }).join('');
}

/* ================== Date modal (copiado / adaptado) ================== */
function calPad2(n){ return String(n).padStart(2,'0'); }
function calInitSimplePicker(){
  const dSel=document.getElementById('evtDia'), mSel=document.getElementById('evtMes'), aSel=document.getElementById('evtAnio');
  if(dSel && !dSel.childElementCount){
    for(let d=1; d<=31; d++){ const opt=document.createElement('option'); opt.value=calPad2(d); opt.textContent=opt.value; dSel.appendChild(opt); }
  }
  if(mSel && !mSel.childElementCount){
    const mesesNombres=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    for(let i=0;i<12;i++){ const opt=document.createElement('option'); opt.value=calPad2(i+1); opt.textContent=mesesNombres[i]; mSel.appendChild(opt); }
  }
  if(aSel && !aSel.childElementCount){
    const thisYear = new Date().getFullYear();
    for(let y=thisYear-2; y<=thisYear+5; y++){ const opt=document.createElement('option'); opt.value=String(y); opt.textContent=String(y); if(y===thisYear) opt.selected=true; aSel.appendChild(opt); }
  }
}
calInitSimplePicker();

let dateModalTargetInputId = null;
function showDatePicker(targetInputId, initialValue){
  dateModalTargetInputId = targetInputId;
  const modal = document.getElementById('eventoFechaModal');
  const dSel=document.getElementById('evtDia'), mSel=document.getElementById('evtMes'), aSel=document.getElementById('evtAnio');
  if(initialValue && /^\d{2}\/\d{2}\/\d{4}$/.test(initialValue)){
    const parts = initialValue.split('/'); dSel.value=parts[0]; mSel.value=parts[1]; aSel.value=parts[2];
  } else {
    const today=new Date(); dSel.value=calPad2(today.getDate()); mSel.value=calPad2(today.getMonth()+1); aSel.value=String(today.getFullYear());
  }
  modal.style.display='flex';
  modal.setAttribute('aria-hidden','false');
}
document.getElementById('evtFechaCancelar').addEventListener('click', ()=>{
  const modal=document.getElementById('eventoFechaModal'); modal.style.display='none'; modal.setAttribute('aria-hidden','true'); dateModalTargetInputId=null;
});
document.getElementById('evtFechaOk').addEventListener('click', ()=>{
  const d=document.getElementById('evtDia').value, m=document.getElementById('evtMes').value, y=document.getElementById('evtAnio').value;
  const val = `${d}/${m}/${y}`;
  if(dateModalTargetInputId){
    // may be inside sweetalert, so querySelector in document
    const el = document.getElementById(dateModalTargetInputId);
    if(el) el.value = val;
    else {
      // try inside swal modal (swal creates its own DOM)
      const swalEl = document.querySelector('.swal2-container #' + dateModalTargetInputId);
      if(swalEl) swalEl.value = val;
    }
  }
  const modal=document.getElementById('eventoFechaModal'); modal.style.display='none'; modal.setAttribute('aria-hidden','true'); dateModalTargetInputId=null;
});

/* ================== Add / Edit Medicamento ================== */
function isDDMMYYYY(s){ return /^\d{2}\/\d{2}\/\d{4}$/.test(String(s||'').trim()); }

async function nuevoMedicamento(){
  const html = `
    <label style="text-align:left; font-weight:900; color:#007BFF; display:block; margin:0 0 6px;">Nombre</label>
    <input id="m-nombre" type="text" class="swal2-input" style="width:100%; margin:0;" />

    <label style="text-align:left; font-weight:900; color:#007BFF; display:block; margin:10px 0 6px;">Presentación</label>
    <input id="m-pres" type="text" class="swal2-input" style="width:100%; margin:0;" placeholder="Ej: Tableta 500 mg" />

    <label style="text-align:left; font-weight:900; color:#007BFF; display:block; margin:10px 0 6px;">Ubicación</label>
    <input id="m-ubic" type="text" class="swal2-input" style="width:100%; margin:0;" placeholder="Ejemplo: Instante Principal Bloque A" />

    <label style="text-align:left; font-weight:900; color:#007BFF; display:block; margin:10px 0 6px;">Categoría</label>
    <select id="m-cat" class="swal2-select" style="width:100%; margin:0; padding:12px; border-radius:10px; border:2px solid #111;">
      <option value="" disabled selected>Selecciona la categoría</option>
      ${categoryOptionsHtml()}
    </select>

    <label style="text-align:left; font-weight:900; color:#007BFF; display:block; margin:10px 0 6px;">Fecha de vencimiento (dd/mm/yyyy)</label>
    <input id="m-v" type="text" class="swal2-input" readonly style="cursor:pointer;" onclick="showDatePicker('m-v')" placeholder="31/12/2026" />
  `;

  const { value: v } = await Swal.fire({
    icon:'info',
    title:'Nuevo Medicamento',
    html,
    showCancelButton:true,
    confirmButtonText:'Crear',
    cancelButtonText:'Cancelar',
    preConfirm: ()=>{
      const nombre = (document.getElementById('m-nombre').value||'').trim();
      const presentacion = (document.getElementById('m-pres').value||'').trim();
      const ubicacion = (document.getElementById('m-ubic').value||'').trim();
      const categoria = (document.getElementById('m-cat').value||'').trim();
      const fecha_vencimiento = (document.getElementById('m-v').value||'').trim();
      if(!nombre) return Swal.showValidationMessage('Nombre requerido');
      if(!presentacion) return Swal.showValidationMessage('Presentación requerida');
      if(!ubicacion) return Swal.showValidationMessage('Ubicación requerida');
      if(!categoria) return Swal.showValidationMessage('Categoría requerida');
      if(!isDDMMYYYY(fecha_vencimiento)) return Swal.showValidationMessage('Fecha inválida. Usa dd/mm/yyyy');
      return { nombre, presentacion, ubicacion, categoria, fecha_vencimiento };
    }
  });
  if(!v) return;
  const r = await apiPost('addmedicamento', v);
  await Swal.fire({ icon:'success', title:'Creado', text:'ID: '+r.id_med, timer:1500, showConfirmButton:false });
  await apiPost('rebuildstock', {});
  await loadStock();
}

async function editarMedicamento(id_med){
  try{
    const med = await apiGet('getmedicamento',{ id: id_med });
    if(!med) return Swal.fire({ icon:'info', title:'No encontrado' });

    const html = `
      <label style="text-align:left; font-weight:900; color:#007BFF; display:block; margin:0 0 6px;">Nombre</label>
      <input id="m-nombre" type="text" class="swal2-input" style="width:100%; margin:0;" value="${escapeHtml(med.NOMBRE||'')}" />

      <label style="text-align:left; font-weight:900; color:#007BFF; display:block; margin:10px 0 6px;">Presentación</label>
      <input id="m-pres" type="text" class="swal2-input" style="width:100%; margin:0;" value="${escapeHtml(med.PRESENTACION||'')}" />

      <label style="text-align:left; font-weight:900; color:#007BFF; display:block; margin:10px 0 6px;">Ubicación</label>
      <input id="m-ubic" type="text" class="swal2-input" style="width:100%; margin:0;" value="${escapeHtml(med.UBICACION||'')}" />

      <label style="text-align:left; font-weight:900; color:#007BFF; display:block; margin:10px 0 6px;">Categoría</label>
      <select id="m-cat" class="swal2-select" style="width:100%; margin:0; padding:12px; border-radius:10px; border:2px solid #111;">
        <option value="" disabled>Selecciona la categoría</option>
        ${categoryOptionsHtml(med.CATEGORIA||'')}
      </select>

      <label style="text-align:left; font-weight:900; color:#007BFF; display:block; margin:10px 0 6px;">Fecha de vencimiento (dd/mm/yyyy)</label>
      <input id="m-v" type="text" class="swal2-input" readonly style="cursor:pointer;" onclick="showDatePicker('m-v','${escapeHtml(med.FECHA_VENCIMIENTO||'')}')" value="${escapeHtml(med.FECHA_VENCIMIENTO||'')}" />
    `;

    const { value: v } = await Swal.fire({
      icon:'info',
      title:'Editar Medicamento',
      html,
      showCancelButton:true,
      confirmButtonText:'Guardar',
      cancelButtonText:'Cancelar',
      preConfirm: ()=>{
        const nombre = (document.getElementById('m-nombre').value||'').trim();
        const presentacion = (document.getElementById('m-pres').value||'').trim();
        const ubicacion = (document.getElementById('m-ubic').value||'').trim();
        const categoria = (document.getElementById('m-cat').value||'').trim();
        const fecha_vencimiento = (document.getElementById('m-v').value||'').trim();
        if(!nombre) return Swal.showValidationMessage('Nombre requerido');
        if(!presentacion) return Swal.showValidationMessage('Presentación requerida');
        if(!ubicacion) return Swal.showValidationMessage('Ubicación requerida');
        if(!categoria) return Swal.showValidationMessage('Categoría requerida');
        if(!isDDMMYYYY(fecha_vencimiento)) return Swal.showValidationMessage('Fecha inválida. Usa dd/mm/yyyy');
        return { nombre, presentacion, ubicacion, categoria, fecha_vencimiento };
      }
    });
    if(!v) return;

    const body = Object.assign({ id_med }, v);
    const res = await apiPost('updatemedicamento', body);
    await Swal.fire({ icon:'success', title:'Guardado', timer:1400, showConfirmButton:false });
    await apiPost('rebuildstock', {});
    await loadStock();
  }catch(e){
    Swal.fire({ icon:'error', title:'Error', text:String(e.message||e) });
  }
}

/* ================== Movimiento (Entrada/Salida) ================== */
async function movimiento(id_med, tipo){
  const usuario = (document.getElementById('usuario').value||'').trim()||'WEB';
  const { value: form } = await Swal.fire({
    icon:'question',
    title: (tipo==='ENTRADA'?'Entrada':'Salida') + ' - ' + id_med,
    html: `
      <label style="text-align:left; font-weight:900; color:#007BFF; display:block; margin:0 0 6px;">Cantidad</label>
      <input id="mv-cant" type="number" min="1" step="1" class="swal2-input" style="width:100%; margin:0;" />
      <label style="text-align:left; font-weight:900; color:#007BFF; display:block; margin:10px 0 6px;">Observación</label>
      <input id="mv-obs" type="text" class="swal2-input" style="width:100%; margin:0;" placeholder="Opcional" />
    `,
    showCancelButton:true,
    confirmButtonText:'Guardar',
    cancelButtonText:'Cancelar',
    preConfirm: ()=>{
      const cant = Number(document.getElementById('mv-cant').value);
      const obs = (document.getElementById('mv-obs').value||'').trim();
      if(!(cant>0)) return Swal.showValidationMessage('Cantidad inválida');
      return { cant, obs };
    }
  });
  if(!form) return;
  try{
    const r = await apiPost('movimiento',{ id_med, tipo, cantidad: form.cant, observacion: form.obs, usuario });
    await Swal.fire({ icon:'success', title:'Registrado', text:`Nuevo stock: ${r.stock} (${r.estado})`, timer:1500, showConfirmButton:false });
    await loadStock();
  }catch(e){
    Swal.fire({ icon:'error', title:'Error', text:String(e.message||e) });
  }
}

/* ================== Buttons ================== */
document.getElementById('btn-cargar').addEventListener('click', ()=> loadStock().catch(e=>Swal.fire({icon:'error',title:'Error',text:String(e.message||e)})));
document.getElementById('btn-nuevo').addEventListener('click', ()=> nuevoMedicamento());
document.getElementById('btn-clear').addEventListener('click', ()=>{ playSoundOnce(SOUNDS.back); document.getElementById('q').value=''; document.getElementById('list').innerHTML=''; });

document.getElementById('q').addEventListener('input', () => {
  // usa una variable con nombre claro para evitar colisiones
  clearTimeout(window.__qDebounceTimer);
  // esperar 2500ms antes de ejecutar la búsqueda
  window.__qDebounceTimer = setTimeout(() => {
    loadStock().catch(()=>{});
  }, 2500);
});

/* ================== init ================== */
window.addEventListener('load', ()=>{ loadStock().catch(()=>{}); });
</script>
</body>
</html>
